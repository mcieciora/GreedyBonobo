import sys
import Transaction as Trc
import Payment as Pmt
import Period as Prd
import utilities as uti
import categories as ctg
import statistics as stat


def main_menu():
    print('[1] Add transaction\n[2] Show history\n[3] Show statistics\n[4] Add/Remove '
          'category\n[5] Update limits\n[6] Manage periods\n[WIP] Analyze history')
    menu_change(input('>>>'))


def add_transaction():
    if Prd.is_period_active():
        answer = input('Would you like to record [c]cost or [i]income? ')
        if answer.lower() == 'c':
            Trc.create_transaction(uti.get_expanse(), uti.get_description(), uti.get_category())
            print('Cost added successfully!')
        elif answer.lower() == 'i':
            Pmt.create_payment(uti.get_payment(), uti.get_description())
            print('Income added successfully!')
        elif answer.lower() == 'q':
            main_menu()
        else:
            print('There is no such option. Please choose proper one!')
    main_menu()


def history():
    if Prd.is_period_active():
        stat.show_history()
    main_menu()


def add_remove_category():
    if Prd.is_period_active() is False:
        answer = input('Would you like to [a]add or [r]remove category? ')
        if answer.lower() == 'a':
            ctg.add_category()
        elif answer.lower() == 'r':
            ctg.remove_category()
        elif answer.lower() == 'q':
            main_menu()
        else:
            print('There is no such option. Please choose proper one!')
            return add_remove_category()
    else:
        print('Categories cannot be modified when period is active!')
    main_menu()


def update_limits():
    print(*ctg.get_categories_list())
    answer = input('Which category limit would you like to update? ')
    if answer in ctg.get_categories_names():
        ctg.update_category_limit(answer)
    elif answer.lower() == 'q':
        main_menu()
    else:
        print('There is no such category!')
        return update_limits()
    main_menu()


def manage_periods():
    answer = input('Would you like to [s]start or [c]close period? ')
    if answer.lower() == 's':
        Prd.start_period()
    elif answer.lower() == 'c':
        if Prd.is_period_active():
            Prd.close_period()
    elif answer.lower() == 'q':
        main_menu()
    else:
        print('There is no such option. Please choose proper one!')
        return manage_periods()
    main_menu()


def statistics():
    if Prd.is_period_active():
        print('Actual period: {}'.format(Prd.get_actual_period_name()))
        print('Available categories: {}'.format([*ctg.get_categories_names()]))
        print(stat.get_total_info())
        print(stat.get_total_savings())
        stat.get_total_categories()
    main_menu()


def analyze_history():
    pass


def menu_change(choice):
    if choice.lower() == 'q':
        sys.exit()
    elif choice in menu_map.keys():
        menu_map[choice]()
    else:
        print('There is no such option, please insert proper one!')
    main_menu()


menu_map = {
    '1': add_transaction,
    '2': history,
    '3': statistics,
    '4': add_remove_category,
    '5': update_limits,
    '6': manage_periods,
    '7': analyze_history,
}

main_menu()
